{% extends 'base.html' %}

{% block title %}AI Chat - KisanBandhu{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
    * { font-family: 'Poppins', 'Inter', sans-serif; }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        overflow-x: hidden;
    }
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        min-height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        padding: 2.5rem;
        border-radius: 24px 24px 0 0;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(17, 153, 142, 0.25);
    }
    .chat-header::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: radial-gradient(circle at 20% 50%,rgba(255,255,255,0.1) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(255,255,255,0.1) 0%,transparent 50%);
        animation: float 15s ease-in-out infinite;
    }
    @keyframes float {
        0%,100%{transform:translateY(0px);}
        50%{transform:translateY(-15px);}
    }
    .chat-header-content { position: relative; z-index: 1; }
    .chat-header h1 {
        font-size: 2.2rem; font-weight: 800; color: white;
        margin-bottom: 0.75rem; display: flex;
        align-items: center; justify-content: center; gap: 0.75rem;
        text-shadow:0 4px 15px rgba(0,0,0,0.15);
    }
    .chat-header p {
        font-size: 1.1rem; color: rgba(255,255,255,0.95); font-weight: 500;
    }
    .language-switch {
        margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;
    }
    .lang-btn {
        padding: 0.4rem 1.2rem; border-radius: 18px; border: none; background: #e8ecf1;
        color: #11998e; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s;
    }
    .lang-btn.active, .lang-btn:focus { background: #11998e; color: white; }
    .messages-area {
        flex:1; background:white; padding:2.5rem; overflow-y:auto;
        border-left: 1px solid rgba(17, 153, 142, 0.1);
        border-right: 1px solid rgba(17, 153, 142, 0.1);
        box-shadow:0 0 30px rgba(0,0,0,0.04);
    }
    .messages-area::-webkit-scrollbar{width:8px;}
    .messages-area::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#11998e,#38ef7d);border-radius:10px;}
    .message{margin-bottom:1.5rem;animation:fadeInUp 0.4s;}
    @keyframes fadeInUp {from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
    .message.bot, .message.user{display:flex;gap:1rem;align-items:flex-start;}
    .message.user{flex-direction:row-reverse;}
    .message-avatar {
        width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .message.bot .message-avatar { background: linear-gradient(135deg, #11998e, #38ef7d); }
    .message.user .message-avatar { background: linear-gradient(135deg, #667eea, #764ba2);}
    .message-bubble { max-width: 75%; padding:1.2rem 1.5rem; border-radius:18px; line-height:1.7; font-size:1rem; box-shadow:0 4px 15px rgba(0,0,0,0.06);}
    .message.bot .message-bubble { background: #f5f7fa; color: #2c3e50; border-bottom-left-radius: 4px;}
    .message.user .message-bubble { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border-bottom-right-radius: 4px;}
    .input-area {
        background:white; padding:2rem; border-radius:0 0 24px 24px;
        border:1px solid rgba(17,153,142,0.1); box-shadow:0 -5px 20px rgba(0,0,0,0.04);
        position: relative;
    }
    .input-container {
        display: flex; gap: 0.7rem; align-items: center;
    }
    #messageInput {
        flex: 1; padding: 1.2rem 1.5rem; border: 2px solid rgba(17,153,142,0.2);
        border-radius: 40px; font-size: 1rem;
        background: #f5f7fa; color: #222;
        transition: border .3s, background .3s;
    }
    #messageInput:focus { outline: none; border-color: #11998e; background:white;
        box-shadow:0 0 0 4px rgba(17,153,142,0.1);}
    .input-btn, .lang-btn {
        outline: none;
    }
    .input-btn {
        width: 50px; height: 50px; border-radius: 50%;
        border: none; cursor: pointer; display: flex;
        align-items: center; justify-content: center; transition: all 0.2s; font-size:1.3rem; position:relative;
        box-shadow:0 4px 13px rgba(17,153,142,0.06);
    }
    .mic-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: box-shadow 0.2s, background 0.2s;
    }
    .mic-btn.listening, .mic-btn:active {
        box-shadow:0 4px 20px #667eea66, 0 0 0 6px #38ef7d55;
        animation: pulseMic 1.1s infinite;
    }
    @keyframes pulseMic {
        0% { box-shadow:0 4px 20px #667eea99, 0 0 0 0 #38ef7d44; }
        70% { box-shadow:0 4px 20px #667eea99, 0 0 0 20px #38ef7d22; }
        100% { box-shadow:0 4px 20px #667eea99, 0 0 0 0 #38ef7d44;}
    }
    .send-btn{background:linear-gradient(135deg,#11998e,#38ef7d);}
    .input-btn svg{width:23px;height:23px;stroke:white;stroke-width:2.2;}
    .input-btn .listening-indicator {
        position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);
        color: #11998e; font-size: 0.95rem; font-weight: 600; letter-spacing: .5px;
        background: #f5f7fa; padding: 2px 10px; border-radius: 9px;
    }
    .suggestion-bar {
        margin-top: 1rem; text-align: center; font-size: 1.03rem; color: #267c75; font-weight:500;
        display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
    }
    .suggestion-chip {
        background: #f5f7fa; color: #11998e; border-radius: 16px; padding: 0.5em 1.1em; font-size:0.95em;
        cursor:pointer;transition: background .2s, color .2s;
        border:1.5px solid #38ef7d66;margin:2px;
    }
    .suggestion-chip:hover { background: #38ef7d; color: white; }
    .loading-dots { display: inline-flex; gap: 6px;}
    .loading-dots span{ width:8px;height:8px;background:#11998e;border-radius:50%;animation:bounce 1.4s infinite ease-in-out;}
    .loading-dots span:nth-child(1){animation-delay:-.32s;}
    .loading-dots span:nth-child(2){animation-delay:-.16s;}
    @keyframes bounce{0%,80%,100%{transform:scale(0);}40%{transform:scale(1);}}
    @media (max-width: 768px) {
        .chat-container{padding:0.7rem;}
        .chat-header h1{font-size:1.3rem;}
        .messages-area{padding:1rem;}
        .suggestion-bar{font-size:0.93rem;}
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="chat-header-content">
            <h1>
                <span aria-label="AI Bot" role="img">ðŸ¤–</span>
                AI Chat + Voice Assistant
            </h1>
            <p>Ask anything about farming in Hindi, Punjabi, or English</p>
            <!-- Language Switcher -->
            <div class="language-switch" aria-label="Language options">
                <button class="lang-btn active" id="lang-en" aria-label="Switch to English">English</button>
                <button class="lang-btn" id="lang-hi" aria-label="Switch to Hindi">à¤¹à¤¿à¤‚à¤¦à¥€</button>
                <button class="lang-btn" id="lang-pa" aria-label="Switch to Punjabi">à¨ªà©°à¨œà¨¾à¨¬à©€</button>
            </div>
        </div>
    </div>

    <!-- Messages Area -->
    <div class="messages-area" id="messagesArea" aria-live="polite">
        <!-- Welcome Message -->
        <div class="message bot">
            <div class="message-avatar">ðŸ‘‹</div>
            <div class="message-bubble">
                Hello! I'm your AI farm assistant. Ask me anything about crops, pests, weather, or soil health!
            </div>
        </div>
    </div>

    <!-- Suggested Questions Bar -->
    <div class="suggestion-bar">
        <span class="suggestion-chip">What fertilizer is best for wheat?</span>
        <span class="suggestion-chip">Will it rain tomorrow?</span>
        <span class="suggestion-chip">Diagnose rice leaf disease</span>
        <span class="suggestion-chip">Suggest NPK for potatoes</span>
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div class="input-container">
            <input
                type="text"
                id="messageInput"
                placeholder="Type your message or use voice..."
                aria-label="Type your message or use voice"
                autocomplete="off"
            />

            <button class="input-btn mic-btn" id="micBtn" aria-label="Voice Input" title="Voice Input">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
                <span class="listening-indicator" id="listeningIndicator" style="display:none;">Listeningâ€¦</span>
            </button>
            <button class="input-btn send-btn" id="sendBtn" aria-label="Send Message" title="Send Message">
                <svg viewBox="0 0 24 24" fill="none">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const listeningIndicator = document.getElementById('listeningIndicator');
    let currentLanguage = 'en';

    // Example suggestions
    document.querySelectorAll('.suggestion-chip').forEach(el => {
        el.addEventListener('click',() => {
            messageInput.value = el.textContent;
            sendMessage();
        });
    });

    // Language Switch
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click',function() {
            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            if(btn.id === 'lang-hi') currentLanguage = 'hi';
            else if(btn.id === 'lang-pa') currentLanguage = 'pa';
            else currentLanguage = 'en';
            messageInput.placeholder = currentLanguage==="en" ? "Type your message or use voice..." : btn.textContent + " à¤®à¥‡à¤‚ à¤²à¤¿à¤–à¥‡à¤‚ à¤¯à¤¾ à¤•à¤¹à¥‡à¤‚...";
            messageInput.focus();
        });
    });

    // Send message function
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        messageInput.value = '';
        const loadingId = Date.now();
        addLoadingMessage(loadingId);

        fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message, lang: currentLanguage })
        })
        .then(response => response.json())
        .then(data => {
            removeLoadingMessage(loadingId);
            addMessage(data.response, 'bot');
        })
        .catch(error => {
            removeLoadingMessage(loadingId);
            addMessage('Sorry, something went wrong. Please try again.', 'bot');
        });
    }

    // Add message to chat
    function addMessage(text, type) {
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        const avatar = document.createElement('div');
        avatar.className = "message-avatar";
        avatar.textContent = type === 'bot' ? 'ðŸ¤–' : 'ðŸ‘¤';
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble'; bubble.textContent = text;
        msg.appendChild(avatar); msg.appendChild(bubble);
        messagesArea.appendChild(msg);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // Add loading message
    function addLoadingMessage(id) {
        const d = document.createElement('div');
        d.className = 'message bot';
        d.id = `loading-${id}`;
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar'; avatar.textContent = 'ðŸ¤–';
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
        d.appendChild(avatar); d.appendChild(bubble);
        messagesArea.appendChild(d); messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // Remove loading message
    function removeLoadingMessage(id) {
        const elem = document.getElementById(`loading-${id}`);
        if(elem) elem.remove();
    }

    // Events
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // Voice input with Web Speech API (browser support required)
    let recognizing = false, recognition;
    micBtn.addEventListener('click', () => {
        if (!('webkitSpeechRecognition' in window)) {
            alert('Voice recognition not supported in your browser.');
            return;
        }
        if (!recognizing) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = currentLanguage==="hi" ? "hi-IN" : currentLanguage==="pa" ? "pa-IN" : "en-US";
            recognition.continuous = false; recognition.interimResults = false;
            recognition.onstart = () => {
                recognizing = true;
                micBtn.classList.add('listening');
                listeningIndicator.style.display = "";
            };
            recognition.onresult = event => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                sendMessage();
            };
            recognition.onerror = recognition.onend = function() {
                recognizing = false;
                micBtn.classList.remove('listening');
                listeningIndicator.style.display = "none";
            };
            recognition.start();
        } else if (recognition) {
            recognition.stop();
        }
    });
</script>
{% endblock %}